!function(e,t){for(var s in t)e[s]=t[s]}(exports,function(e){var t={};function s(n){if(t[n])return t[n].exports;var r=t[n]={i:n,l:!1,exports:{}};return e[n].call(r.exports,r,r.exports,s),r.l=!0,r.exports}return s.m=e,s.c=t,s.d=function(e,t,n){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(s.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)s.d(n,r,function(t){return e[t]}.bind(null,r));return n},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s=93)}({1:function(e,t){e.exports=require("path")},10:function(e,t){e.exports=require("util")},11:function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=s(1),r=s(4),o=s(2),i=s(6),a=s(7),c=s(10);function l(){const e=process.env.hasOwnProperty("PROCESSOR_ARCHITEW6432"),t=process.env.SystemRoot;if(t)return n.join(t,e?"Sysnative":"System32","wslconfig.exe")}let u,d;function h(){if("number"!=typeof u){const e=/(\d+)\.(\d+)\.(\d+)/g.exec(r.release());u=e&&4===e.length?parseInt(e[3]):0}return u}t.WIN10_1903_LABEL="Windows 10, May 2019 Update, version 1903",t.WIN10_1803_LABEL="Windows 10, April 2018 Update, version 1803",t.isDistroEnvVarAvailable=function(){return h()>=18362},t.isWSLPathAvailable=function(){return h()>=17046},t.isExecArgumentSupported=function(){return h()>=17666},t.getWSLExecutablePath=function(){let e=h()>=16299;const t=process.env.hasOwnProperty("PROCESSOR_ARCHITEW6432"),s=process.env.SystemRoot;if(s)return n.join(s,t?"Sysnative":"System32",e?"wsl.exe":"bash.exe")},t.getWSLConfigExecutablePath=l,t.getWindowsBuildNumber=h,t.getProductConfiguration=function(e){if(!d){const t=o.readFileSync(n.join(e,"product.json")).toString();d=JSON.parse(t)}return d};const f=/^[\w\d+\.\-_~!$&'\(\)\*\+,;=]+$/,p="+".charCodeAt(0);t.DEFAULT_AUTHORITY="wsl+default",t.getAuthorityFromDistro=function(e){return e?f.test(e)&&"default"!==e&&e.charCodeAt(0)!==p?"wsl+"+e:"wsl++"+Buffer.from(e,"utf8").toString("hex"):t.DEFAULT_AUTHORITY},t.getDistroFromAuthority=function(e){if(/^wsl\+/.test(e)){const t=e.substr(4);return"default"===t?void 0:t.charCodeAt(0)===p?Buffer.from(t.substr(1),"hex").toString("utf8"):t}throw new Error("authority must start with wsl+")},t.getDistros=function(){return new Promise((e,t)=>{const s=l();s?i.execFile(s,["/list"],{windowsVerbatimArguments:!0,encoding:"utf16le"},(s,n,r)=>{if(s)t(s);else{const t=/\r\n/.test(n)?"\r\n":"\n",s=n.split(t);let r=[];for(let e=1;e<s.length;e++){let t=s[e].match(/^[a-zA-Z0-9\.\-_]+/);t&&r.push(t[0])}e(r)}}):t(new Error("Unable to find location of wslconfig.exe"))})},t.toForwardSlashes=function(e){return e.replace(/[\\\/]/g,n.posix.sep)},t.donwloadBuild=async function(e,t,s){await async function e(t){await c.promisify(o.exists)(t)||(await e(n.dirname(t)),await c.promisify(o.mkdir)(t))}(n.dirname(t));const r=`${e.updateUrl}/commit:${e.commit}/server-linux-x64/${e.quality||"insider"}`,i=`${t}_${Date.now()}`;return function e(t,s,n,r=5){return new Promise((i,c)=>{const l=o.createWriteStream(s),u=a.get(t,o=>{if(r>0&&(o.statusCode>=300&&o.statusCode<=303||307===o.statusCode)){let t=o.headers.location;if(t)return void e(t,s,n,r-1).then(i,c)}if(o.statusCode<200||o.statusCode>299)return void c(`Failed to download VS Code Server from ${t}: HTTP ${o.statusCode} - ${o.statusMessage}`);const a=parseInt(o.headers["content-length"]||"0");let u=0;a&&o.on("data",e=>{u+=e.length,n(u,a)}),o.on("error",c),o.pipe(l),o.on("end",i)});u.on("error",c)})}(r,i,s).then(e=>c.promisify(o.rename)(i,t).then(e=>t))},t.getServerTarCacheLocation=function(e){return n.join(r.tmpdir(),"vscode-remote-wsl",e.commit,"vscode-server-linux-x64.tar.gz")}},2:function(e,t){e.exports=require("fs")},4:function(e,t){e.exports=require("os")},6:function(e,t){e.exports=require("child_process")},7:function(e,t){e.exports=require("https")},93:function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=s(94),r=s(6),o=s(2),i=s(4),a=s(11),c=s(1),l=s(95),u=process.env.VSCODE_WSL_AGENT_DEBUG_PORT,d=process.env.VSCODE_WSL_PIPE_NAME,h=parseInt(process.env.VSCODE_WSL_EXT_HOST_PID||"0",10),f=process.env.VSCODE_WSL_EXT_LOCATION,p=process.env.VSCODE_WSL_APP_ROOT,g=process.env.VSCODE_WSL_ENABLE_TELEMETRY||!1,S=process.env.VSCODE_FILE_WATCHER_POLLING||0,w=process.env.VSCODE_WSL_DISTRO;class _{constructor(e,t){this.increment=e,this.message=t,this.type="progressMessage"}}t.ProgressMessage=_;class m{constructor(e){this.data=e,this.type="stdoutMessage"}}t.StdoutMessage=m;class v{constructor(e){this.data=e,this.type="stderrMessage"}}t.StderrMessage=v;class y{constructor(e,t,s){this.host=e,this.port=t,this.wslVersion=s,this.type="portResolved"}}t.PortResolvedMessage=y;class L{constructor(e,t){this.message=e,this.wslVersion=t,this.type="fatalErrorOccured"}}t.FatalErrorOccuredMessage=L;let b=null,E=[];function C(e){for(let t=0;t<E.length;t++)E[t]===e&&E.splice(t,1);0===E.length&&process.exit(0)}!function(){const e=new class{send(e){process.stdout.write(JSON.stringify(e)+"\n")}};E.push(e);let t=setInterval(function(){try{process.kill(h,0)}catch(s){clearInterval(t),C(e)}},1e3)}();const x=n.createServer(e=>{const t=new l.SimpleProtocol(e),s=new class{send(e){t.send(e)}};E.push(s),t.onMessage=(()=>{throw new Error("Received unexpected message")}),b&&s.send(b),e.on("close",()=>{C(s)})});function $(e){e&&"EADDRINUSE"===e.code||(console.error(e),process.exit(0));let t=e=>{console.error(e),process.exit(0)},s=n.createConnection(d,()=>{s.removeListener("error",t),new l.SimpleProtocol(s).onMessage=(e=>{O(e)}),s.on("close",()=>{process.exit(0)})});s.once("error",t)}function O(e){E.forEach(t=>{t.send(e)})}function P(e){const t=i.networkInterfaces(),s={};for(let e in t)for(let n of t[e])s[n.address]=!0;return e.length&&!e.some(e=>s[e])?e[0]:"127.0.0.1"}x.on("error",$),x.listen(d,async()=>{let e;x.removeListener("error",$);let t="",s=0,n="",i=[],l="";const d=t=>{clearTimeout(e),O(b=new L(t,l))},h=e=>{const t=e.match(/(\d+)%$/);let r=0;if(t){const e=Math.min(parseInt(t[1],10),100);0===e&&(s=0),e>s&&(r=e-s,s=e)}(n!==e||r>0)&&(n=e,O(new _(r/2,e)))},E=()=>{let s=!1;if(M)M=!1,W=0,I&&(O(new _(0,"Installing WSL components")),I=!1);else if(++W>300)return void d(`VS Code Server for WSL failed to start. No messages received for ${Math.floor(90)}s`);return C.length&&(O(new m(C)),s=(s=>{for(let n=0;n<s.length;n++){const r=s.charCodeAt(n);if(10===r){let s=t.match(/Extension host agent listening on (\d+)/);if(s)return clearTimeout(e),O(b=new y(P(i),parseInt(s[1],10),l)),!0;(s=t.match(/IP Address: ([\d\.]+)/))?i.push(s[1]):(s=t.match(/WSL version: (.+)/))&&(l=s[1]),h(t),t=""}else 8===r?10!==t.charCodeAt(t.length-1)&&(t=t.substr(0,t.length-1)):t+=s.charAt(n)}return h(t),!1})(C),C=""),A.length&&(O(new v(A)),A=""),s};let C="",A="",M=!1,W=0,I=!0;e=setInterval(E,300);const T=a.getWSLExecutablePath();if(!T||!o.existsSync(T))return void d(`VS Code Server for WSL failed. '${T}' not found.\n\nMake sure WSL is installed:\nhttps://aka.ms/vscode-remote/wsl/install-wsl`);const D=a.getProductConfiguration(p),{commit:k,quality:B,serverDataFolderName:R}=D;if(k&&!B)return void d(`VSCode Client (${p}) does not define a quality.`);const V=R||".vscode-remote",j=a.isWSLPathAvailable();let N="";if(k&&j){if(N=a.getServerTarCacheLocation(D),!o.existsSync(N))try{if(function(e,t,s,n){let o;const i=`[ -d ~/${s}/bin/${n} ] && echo found || echo missing`;if(a.isExecArgumentSupported()){const s=t?`-d ${t}`:"";o=`${e} ${s} -e bash -c "${i}"`}else o=`${e} ${i}`;return O(new m(`Probing if server is already installed: ${o}`)),-1!==r.execSync(o,{stdio:[null,null,null]}).toString().indexOf("found")}(T,w,V,k))N="",O(new m("Server install found in WSL"));else{O(new m("No server install found on WSL, downloading server on client side..."));let e=0;await a.donwloadBuild(D,N,(t,s)=>{const n=Math.ceil(50*t/s);n>e&&(O(new _(n-e,"Downloading server...")),e=n)})}}catch(e){O(new v(`Unable to detect if server is already installed: ${e}`)),N=""}N=a.toForwardSlashes(N)}const U=u?`--inspect=0.0.0.0:${u}`:"",F=g?"":"--disable-telemetry";let H=k?"./scripts/wslServer.sh":"./scripts/wslServer-dev.sh";j&&(H=`\\"$(wslpath -u '${a.toForwardSlashes(c.join(f,H))}')\\"`);const q=k?`"${H} '${k}' '${B}' '${V}' '${N}' ${S} ${U} ${F}"`:`"${H} '${p}' ${S} ${U}"`,J=[];a.isExecArgumentSupported()?(w&&J.push("-d",w),J.push("-e","bash","-c",q)):"wsl.exe"===c.basename(T).toLowerCase()?J.push("bash","-c",q):J.push("-c",q),O(new m(`Launching ${T} ${J.join(" ")} in ${f}`));const G=r.spawn(T,J,{cwd:f,windowsVerbatimArguments:!0});G.stdout.on("data",e=>{C+=e.toString(),M=!0}),G.stderr.on("data",e=>{A+=e.toString(),M=!0}),G.on("error",e=>{E()||d(`VS Code Server for WSL failed with error:\r\n${e.message}`)}),G.on("close",e=>{E()||d("VS Code Server for WSL closed unexpectedly.")})})},94:function(e,t){e.exports=require("net")},95:function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.SimpleProtocol=class{constructor(e){this.onMessage=null,this.onClose=null,this._byteProtocol=new n(e),this._byteProtocol.onClose=(()=>{this.onClose&&this.onClose()}),this._byteProtocol.onMessage=(e=>{if(!this.onMessage)throw new Error("Incorrect usage!");this.onMessage(JSON.parse(e.toString()))})}send(e){this._byteProtocol.send(Buffer.from(JSON.stringify(e)))}};class n{constructor(e){this._socket=e,this._writeBuffer=new class{constructor(){this._data=[],this._totalLength=0}add(e,t){const s=0===this._totalLength;return this._data.push(e,t),this._totalLength+=e.length+t.length,s}take(){const e=Buffer.concat(this._data,this._totalLength);return this._data.length=0,this._totalLength=0,e}},this._chunks=[],this.onMessage=null,this.onClose=null;let t=0;const s={readHead:!0,bodyLen:-1};this._socketDataListener=(e=>{for(this._chunks.push(e),t+=e.length;t>0;){if(s.readHead){if(!(t>=n._headerLen))break;{const e=Buffer.concat(this._chunks);s.bodyLen=e.readUInt32BE(0),s.readHead=!1;const r=e.slice(n._headerLen);t=r.length,this._chunks=[r]}}if(!s.readHead){if(!(t>=s.bodyLen))break;{const e=Buffer.concat(this._chunks),n=e.slice(0,s.bodyLen),r=e.slice(s.bodyLen);if(t=r.length,this._chunks=[r],s.bodyLen=-1,s.readHead=!0,!this.onMessage)throw new Error("Incorrect usage!");this.onMessage(n)}}}}),e.on("data",this._socketDataListener),this._socketCloseListener=(()=>{this.onClose&&this.onClose()}),e.once("close",this._socketCloseListener)}send(e){const t=Buffer.allocUnsafe(n._headerLen);t.writeUInt32BE(e.length,0,!0),this._writeSoon(t,e)}_writeSoon(e,t){this._writeBuffer.add(e,t)&&setImmediate(()=>{this._socket.destroyed||this._socket.write(this._writeBuffer.take())})}}n._headerLen=4,t.ByteProtocol=n}}));
//# sourceMappingURL=wslDaemon.js.map